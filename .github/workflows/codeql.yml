name: CodeQL Analysis

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build and Analyze
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up CodeQL
        uses: github/codeql-action/setup@v1

      - name: Build and Analyze C files
        run: |
          # Get the list of C files in the repository
          c_files=$(find . -name '*.c')

          # Create a directory to store analysis results
          mkdir analysis_results

          # Build and analyze each C file individually
          for file in $c_files; do
            # Extract the filename without extension
            filename=$(basename -- "$file")
            filename="${filename%.*}"

            # Build the file using the appropriate compiler
            gcc -o "$filename" "$file"

            # Analyze the file and generate SARIF results
            codeql database create --language=cpp --source-root="$filename" --source-root=.

            codeql query run --database="$filename" --format=sarif-latest --output="analysis_results/$filename.sarif"

            # Clean up the database after analysis
            codeql database remove "$filename"
          done

      - name: Upload analysis results
        uses: github/codeql-action/upload-sarif@v1
        with:
          sarif_file: analysis_results/*.sarif
